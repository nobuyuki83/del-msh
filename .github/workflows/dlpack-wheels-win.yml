name: dlpack-wheels-win

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  win-wheels:
    runs-on: self-hosted
    labels: [windows, windows-gpu]
    strategy:
      fail-fast: false
      matrix:
        python: ["3.9", "3.10", "3.11", "3.12"]
        include:
          - cuda: "12.1"
            cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.1"
            cutag: "cu121"
          - cuda: "12.6"
            cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.6"
            cutag: "cu126"
          - cuda: "12.9"
            cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.9"
            cutag: "cu129"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: x64

      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-x86_64-pc-windows-msvc

      - name: Build wheel (isolate CUDA version)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $cuda  = "${{ matrix.cuda_path }}"
          $cutag = "${{ matrix.cutag }}"
          $py    = "${{ matrix.python }}"

          Write-Host "=== Using CUDA $cutag ==="
          # --- 他 CUDA bin を除去して対象のみ前置き ---
          $parts = $env:PATH -split ';' | ? { $_ -notmatch 'NVIDIA GPU Computing Toolkit\\CUDA\\v\d+\.\d+\\bin' }
          $env:PATH = @("$cuda\bin", "$cuda\extras\CUPTI\lib64") + $parts -join ';'
          # --- 併用環境変数固定 ---
          $env:CUDA_PATH = $cuda
          $env:CUDA_HOME = $cuda
          $env:CUDAToolkit_ROOT = $cuda
          $env:INCLUDE = "$cuda\include;$env:INCLUDE"
          $env:LIB     = "$cuda\lib\x64;$env:LIB"
          # --- ターゲットディレクトリ分離 ---
          $env:CARGO_TARGET_DIR = "target\cu$cutag\py$py"

          # --- 確認 ---
          & "$cuda\bin\nvcc.exe" --version
          where.exe nvrtc64_*.dll

          # --- ビルド ---
          python -m pip install -U pip maturin
          maturin build --release -i python -m pyproject.toml

          # --- CUDA タグ付きファイル名にリネーム ---
          $whl = Get-ChildItem target\wheels\*.whl | Select-Object -First 1
          if (-not $whl) { throw "wheel not found" }
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          $new = $whl.Name -replace '\.whl$', ".${cutag}.whl"
          Copy-Item $whl.FullName -Destination ("dist\" + $new)
          Write-Host "Created dist\$new"

      - uses: actions/upload-artifact@v4
        with:
          name: "win-py${{ matrix.python }}-${{ matrix.cutag }}"
          path: dist\*.whl