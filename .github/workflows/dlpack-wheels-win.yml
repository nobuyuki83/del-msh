name: dlpack-wheels-win

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        python_spec:
          - { py: "3.11", py_root: "C:\\Users\\Nobuyuki Umetani\\AppData\\Local\\Programs\\Python\\Python311" }
          - { py: "3.13", py_root: "C:\\Users\\Nobuyuki Umetani\\AppData\\Local\\Programs\\Python\\Python313" }
        cuda_spec:
          - { cuda: "12.1", cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.1", cutag: "cu121" }
          - { cuda: "12.6", cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.6", cutag: "cu126" }

    steps:
      - uses: actions/checkout@v4

      - name: Use preinstalled Python (no registry)
        shell: powershell
        run: |
          $py = "${{ matrix.python_spec.py_root }}"
          # PATH 先頭に Python と Scripts を追加（後続ステップへ永続）
          Add-Content -Path $env:GITHUB_PATH -Value "$py"
          Add-Content -Path $env:GITHUB_PATH -Value "$py\Scripts"
          "PYTHONUTF8=1"                    | Out-File $env:GITHUB_ENV -Append -Encoding utf8
          "PIP_DISABLE_PIP_VERSION_CHECK=1" | Out-File $env:GITHUB_ENV -Append -Encoding utf8
          "PIP_NO_INPUT=1"                  | Out-File $env:GITHUB_ENV -Append -Encoding utf8

      - name: Check Python
        shell: powershell
        run: |  
          $py = "${{ matrix.python_spec.py_root }}"
          # ここが肝：このステップの PATH 先頭に“前置”する
          $env:Path = "$py;$py\Scripts;$env:Path"
          python --version
          where.exe python
          python -m pip --version

      - name: Check Rust toolchain
        run: |
          rustc -V
          cargo -V          

      - name: Build wheel (isolate CUDA and PATH)
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $cuda  = "${{ matrix.cuda_spec.cuda_path }}"
          $cutag = "${{ matrix.cuda_spec.cutag }}"
          $py    = "${{ matrix.python_spec.py }}"

          # --- 他の CUDA bin を PATH から除去し、対象のみ前置き ---
          $parts = $env:PATH -split ';' | ? { $_ -notmatch 'NVIDIA GPU Computing Toolkit\\CUDA\\v\d+\.\d+\\bin' }
          $env:PATH = @("$cuda\bin", "$cuda\extras\CUPTI\lib64") + $parts -join ';'

          # --- 併用される環境変数も固定 ---
          $env:CUDA_PATH = $cuda
          $env:CUDA_HOME = $cuda
          $env:CUDAToolkit_ROOT = $cuda
          $env:INCLUDE = "$cuda\include;$env:INCLUDE"
          $env:LIB     = "$cuda\lib\x64;$env:LIB"

          # --- ビルドキャッシュ取り違え防止（Python×CUDA で分離） ---
          $env:CARGO_TARGET_DIR = "target\${cutag}\py${py}"

          # --- 可視化・確認 ---
          & "$cuda\bin\nvcc.exe" --version
          where.exe nvrtc64_*.dll
          python --version

          # --- 依存導入 & ビルド ---
          python -m pip install -U pip maturin
          
          pwd
          cd del-msh-dlpack
          pwd
          
          echo "huga"
          
          # 必要に応じて features を付与: 例) --features cuda-nvrtc
          $env:NVCC_CCBIN = "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Tools\MSVC\14.38.33130\bin\Hostx64\x64"
          cl.exe /Bv
          nvcc --version
          maturin build --release --features cuda          
          echo "hoge"

          # --- wheel に CUDA タグを付与して dist/ に配置 ---
          #$whl = Get-ChildItem ..\target\wheels\*.whl | Select-Object -First 1
          #if (-not $whl) { throw "wheel not found" }
          #New-Item -ItemType Directory -Path dist -Force | Out-Null
          #$new = $whl.Name -replace '\.whl$', ".${cutag}.whl"
          #Copy-Item $whl.FullName -Destination ("dist\" + $new)
          #Write-Host "Created dist\$new"
          

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: "win-py${{ matrix.python_spec.py }}-${{ matrix.cuda_spec.cutag }}"
          path: dist\*.whl