name: dlpack-wheels-win

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  win-wheels:
    runs-on: self-hosted
    # ラベルで runner を絞る
    labels: [ windows, windows-gpu ]
    strategy:
      fail-fast: false
      matrix:
        python: ["3.9", "3.10", "3.11", "3.12"]
        cuda:   ["12.1", "12.6", "12.9"]
        include:
          - cuda: "12.1"
            cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.1"
            cutag: "cu121"
          - cuda: "12.6"
            cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.6"
            cutag: "cu126"
          - cuda: "12.9"
            cuda_path: "C:\\Program Files\\NVIDIA GPU Computing Toolkit\\CUDA\\v12.9"
            cutag: "cu129"

    env:
      # 各ジョブで CUDA を切替
      CUDA_PATH: ${{ matrix.cuda_path }}
      # cudarc/cudarc-sys が見る PATH（nvrtc/cuda.dll を先頭優先）
      PATH: "${{ matrix.cuda_path }}\\bin;${{ matrix.cuda_path }}\\extras\\CUPTI\\lib64;${{ env.PATH }}"

    steps:
      - uses: actions/checkout@v4

      - name: Show GPU & CUDA selection
        shell: pwsh
        run: |
          nvidia-smi
          "$env:CUDA_PATH"
          & "$env:CUDA_PATH\bin\nvcc.exe" --version

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          architecture: "x64"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-x86_64-pc-windows-msvc
          components: clippy

      - name: Install maturin
        run: |
          python -m pip install -U pip maturin

      # もし PyTorch の ABI に依存しない構成なら、ビルド時に特別な include/lib は不要。
      # NVRTC を使わず静的/動的リンクを明示する場合は下で環境変数/feature を付ける。
      - name: Build wheel (release)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # 例: cudarc の feature 切替があるなら --features を指定
          # maturin build --release -i python --features "cuda-nvrtc" -m pyproject.toml
          maturin build --release -i python -m pyproject.toml

      # （任意）Wheel ファイル名に CUDA タグを付け替える
      - name: Retag wheel with CUDA suffix
        shell: pwsh
        run: |
          $whl = Get-ChildItem target\wheels\*.whl | Select-Object -First 1
          if (-not $whl) { throw "wheel not found" }
          $new = $whl.Name -replace '\.whl$', ".${{ matrix.cutag }}.whl"
          Copy-Item $whl.FullName -Destination ("dist\" + $new)
          Write-Host "Renamed to dist\$new"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "win-${{ matrix.python }}-${{ matrix.cutag }}"
          path: dist\*.whl